#!/usr/bin/env bash

echo "usage: $0 {{comments}}"
echo
comments=$@

if [[ -z "$comments" ]]; then
  comments="$(hostname): work in progress as of $(date -u +%Y-%m-%dT%H:%M:%S%Z)"
  # Alternative date format $(date -u --rfc-3339=s)
  echo "auto comment set: $comments"
  echo
else
  comments="$(hostname): $comments at $(date -u +%Y-%m-%d_T_%H:%M:%S_%Z)"
  echo "$comments"
  echo
fi

CURRENT=$(pwd)
echo ${CURRENT}
while [[ ! $(ls -lah | awk '/\.git/ { print $9 }') ]]
do
  cd ..
done

git pull
echo && echo

git add .
echo
git commit -a -m "$comments" --status
echo
BRANCH=$(git branch --list | grep '*' | awk -F" " '{ print $2 }')
git push -u origin ${BRANCH}
echo && echo && echo

if [[ $(git config --get remote.origin.url) == *"github"* ]]; then
  echo "Done: remote origin is on github.com"
elif [[ $(git config --get remote.origin.url) == *"ilyin.tech"* ]]; then
  echo "git repo is on DSM"
elif [[ -n "$(git config --get remote.origin.url)" ]]; then
  GIT_USER=$(git config --get remote.origin.url | awk -F/ '{ print $3 }' | awk -F@ ' { print $1 }')
  GIT_HOST=$(git config --get remote.origin.url | awk -F/ '{ print $3 }' | awk -F@ ' { print $2 }' | awk -F: '{ print $1 }')
  GIT_PORT=$(git config --get remote.origin.url | awk -F/ '{ print $3 }' | awk -F: '{ print $2 }')
  GIT_PREPATH=$(git config --get remote.origin.url | awk -F: '{ print $3 }')
  GIT_PATH=${GIT_PREPATH:${#GIT_PORT}:$((${#GIT_PREPATH}-1))}

  ssh -p ${GIT_PORT} ${GIT_USER}@${GIT_HOST} 'bash -s' <<EOF
  echo
  hostname
  
  if [ -f "${GIT_PATH}/config" ] && [ -r "${GIT_PATH}/config" ] && [ -s "${GIT_PATH}/config" ]; then
    echo "Testing sed in command substitution:"
    CHECK_REMOTE_URL="\$(sed -n '/\[remote \"origin\"\]/,/url = / p' "${GIT_PATH}/config" 2>&1 | awk '/url = / { print  }')"
    echo "Sed CHECK_REMOTE_URL: \$CHECK_REMOTE_URL"
    echo "Exit code: \$?"

    if [[ -n "${CHECK_REMOTE_URL}" ]]; then
      echo    
      cd ${GIT_PATH}
      pwd
      echo "${GIT_USER}@${GIT_HOST}:${GIT_PORT}${GIT_PATH}$ git push"
      git push
    fi
  fi
EOF
fi

cd ${CURRENT}
